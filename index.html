<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1"> 
  <title>SCADder</title>
  <link rel="stylesheet" href="css/openjscad.css" type="text/css">
  <script type="text/javascript" src="lib/jquery.min.js"></script>
  <!--script type="text/javascript" src="bbui-0.9.5.js"></script-->
  
  <link rel="stylesheet" href="lib/jquery-mobile-1.2.0/jquery.mobile.min.css" />
  <script type="text/javascript" src="lib/jquery-mobile-1.2.0/jquery.mobile.min.js"></script>
  <!--link rel="stylesheet" href="lib/BlackBerry-JQM-all.css" />
  <script type="text/javascript" src="lib/BlackBerry-JQM-all.js"></script-->
	<script src="lib/lawnchair-0.6.1.min.js"></script>
  <style>
body {
  font: 14px/20px 'Helvetica Neue Light', HelveticaNeue-Light, 'Helvetica Neue', Helvetica, Arial, sans-serif;
  /*max-width: 820px;*/
  margin: 0 auto;
  padding: 10px;
}

pre, code, textarea {
  font: 12px/20px Monaco, monospace;
  border: 1px solid #CCC;
  border-radius: 3px;
  background: #F9F9F9;
  padding: 0 3px;
  color: #555;
}
pre, textarea {
  padding: 10px;
  width: 100%;
}
.viewer {
	width:90% !important;
}
#code {
	width: 100%;
}
textarea:focus {
  outline: none;
}
canvas { cursor: move; }
  </style>
<script type="text/javascript" src="lightgl.js"></script>
<script type="text/javascript" src="csg.js"></script>
<script type="text/javascript" src="openjscad.js"></script>
</head>
<body>
	

<div data-role="page" id="pageList">
  <div data-role="content">
  	<ul data-role="listview" id="files"></ul>	
  </div>
  <div data-role="footer" data-position="fixed">
	  <div data-role="navbar">
			<ul>
		      <li><a class="addbtn" href="#pageEditor">Add</a></li>
		      <li><a href="#help">Help</a></li>
			</ul>
	  </div>
  </div>
</div>
<div data-role="page" id="pageViewer">
	<div data-role="content">
		<div id="viewer"></div>
    </div>
    <div data-role="footer" data-position="fixed">
		<div data-role="navbar">
			<ul>
			  <li><a href="#pageList">&lt;</a></li>
			  <li><a href="#pageViewer">Preview</a></li>
			  <li><a href="#pageEditor">Edit</a></li>
			  <li><a href="#pageExport">Export</a></li>
			</ul>
		</div>
	</div>
</div>


<div data-role="page" id="pageEditor">
	<div data-role="content">
		<form action="" data-ajax="false">
        <label for="filename">Filename:</label>
        <input type="text" name="filename" id="filename" value="" />
        <label for="descfield">Description:</label>
        <textarea name="code" id="code"></textarea>
        </form>
        
		<!--input class="savebtn" type="submit" value="Save SCAD file"-->
    </div>
    <div data-role="footer" data-position="fixed">
		<div data-role="navbar">
			<ul>
			  <li><a href="#pageList">&lt;</a></li>
			  <li><a href="#pageViewer">Preview</a></li>
			  <li><a href="#pageEditor">Edit</a></li>
			  <li class="savebtn">Save</li>
			  <li><a href="#pageExport">Export</a></li>
			</ul>
		</div>
	</div>
</div>

<div data-role="page" id="pageExport">
	<div data-role="content">
		Export
	</div>
	<div data-role="footer" data-position="fixed">
		<div data-role="navbar">
			<ul>
			  <li><a href="#pageList">&lt;</a></li>
			  <li><a href="#pageViewer">Preview</a></li>
			  <li><a href="#pageEditor">Edit</a></li>
			  <li><a href="#pageExport">Export</a></li>
			</ul>
		</div>
	</div>
</div>

<script src="local://chrome/webworks.js" type="text/javascript"></script>

<script type="text/javascript">
	var gProcessor=null;
	 var store = new Lawnchair({name:'scadfiles'},function(store){
    	loadFiles(store);
    });
    
	// Show all exceptions to the user:
	OpenJsCad.AlertUserOfUncaughtExceptions();
	function handleTouch(event)
	{
	      var touches = event.changedTouches,
	              first = touches[0],
	              type = '';
	
	      switch(event.type)
	      {
	        case 'touchstart':
	          type = 'mousedown';
	          break;
	
	        case 'touchmove':
	          type = 'mousemove';
	          event.preventDefault();
	          break;
	
	        case 'touchend':
	          type = 'mouseup';
	          break;
	
	        default:
	          return;
	      }
	      var simulatedEvent = document.createEvent('MouseEvent');
	      simulatedEvent.initMouseEvent(type, true, true, window, 1, first.screenX, first.screenY, first.clientX, first.clientY, false, false, false, false, 0, null);
	      first.target.dispatchEvent(simulatedEvent);
	}
	  
	function onload()
	{
	  // Ensure touch support
	  $.fn.addTouch = function(){
	    this.each(function(i,el){
	      $(el).bind('touchstart touchmove touchend touchcancel',function(){
	        handleTouch(event);
	      });
	    });
	   }
	   
	  gProcessor = new OpenJsCad.Processor(document.getElementById("viewer"));
	  updateSolid();
	}
	  
  $(".savebtn").click(function () {
    store.save({filename:$("#filename").val(), code: $("#code").val()});
    loadFiles(store);
    updateSolid
  }); 
  
  $(".addbtn").click(function(){
  	console.log("add");
	  $("#filename").val("");
	  $("#code").val("function main()\n{\nvar resolution = 24; // increase to get smoother corners (will get slow!)\nvar cube1 = CSG.roundedCube({center: [0,0,0], radius: [10,10,10], roundradius: 2, resolution: resolution});\nvar sphere1 = CSG.sphere({center: [5, 5, 5], radius: 10, resolution: resolution });\nvar sphere2 = sphere1.translate([12, 5, 0]);\nvar sphere3 = CSG.sphere({center: [20, 0, 0], radius: 30, resolution: resolution });\nvar result = cube1;\nresult = result.union(sphere1);\nresult = result.subtract(sphere2);\nresult = result.intersect(sphere3);\nreturn result;}");
	  updateSolid();
  });
  
  function loadFiles(store){
	 $("#files").empty();
     store.all(function(obj) {
     	
    	 obj.forEach(function(d) {
    	 	console.log("load ", d)
    		$("#files").append("<li id='" + d.key 
    				+ "'><!--button style='width:60px !important' class='ui-li-aside deletebtn'>delete</button--><h3 class='ui-li-heading'><a class='scadfile' href='#pageEditor'>" 
    					+ d.filename + "</a></h3></li>");
    	 });
     });
     
     $(".deletebtn").click(function () {
   	  	var id = $(this).parent("li").attr("id");
   	    store.remove(id,function(){
   	    	$(this).parent("li").remove();
   	    	loadFiles(store);
   	    });
     });
     $(".scadfile").click(function () {
     	var id = $(this).parent("h3").parent("li").attr("id");
     	console.log("open",id)
     	store.get(id, function(d){
     		$("#filename").val(d.filename);
	  		$("#code").val(d.code);
	  		updateSolid();
     	});
     });
   }     	
    	
	function updateSolid()
	{
	  gProcessor.setJsCad(document.getElementById('code').value);
	}

	window.addEventListener("load", function(e) {
	    document.addEventListener("webworksready", onload);
	}, false);
  
</script>
</body>
</html>
